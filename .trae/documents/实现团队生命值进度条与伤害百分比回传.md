## 需求概述

* 英雄在受伤后，需要回传其当前剩余生命值百分比（0\~1）。

* 页面顶部的 `leftHpBar` 与 `rightHpBar` 显示的是各自队伍的生命值百分比：按队伍内成员的剩余生命值百分比求平均值，即 `(x + y + z) / n`。

## 现有结构梳理

* 伤害流程：`BattlePageManager` 在挂载控制器时注入伤害回调，最终由 `DamageManager.applyDamage` 计算伤害并调用 `HeroController.takeDamage` 扣血（组件/DamageManager.ts:11-36、组件/HeroController.ts:475-490）。

* 页面生命条：`BattlePageManager` 已有 `leftHpBar`、`rightHpBar`（BattlePageManager.ts:42-46），但当前未在受伤事件后更新团队进度。

## 修改方案

### 1. DamageManager 回传受伤者剩余生命值百分比

* 将 `applyDamage(source, target, type)` 的返回值改为 `number`，表示目标受伤后的剩余生命百分比（0\~1）。

* 计算方式：在执行 `defender.takeDamage(...)` 后，通过 `defender.currentHp / defender.maxHp` 得到百分比（若 `maxHp<=0` 则为 0）。

* 位置：组件/DamageManager.ts:11-36。

### 2. 页面计算并刷新团队生命值平均百分比

* 在 `BattlePageManager` 中新增：

  * `calcTeamHpPercentFromNodes(nodes: Node[]): number`：过滤无效节点后，遍历有效英雄的 `HeroController`，求每个的 `currentHp/maxHp`（越界归一到 0\~1），再按成员数量取平均；空队伍返回 0。

  * `updateTeamHpBars()`：分别对左/右队伍调用 `calcTeamHpPercentFromNodes`，将结果直接写入 `leftHpBar.progress` 与 `rightHpBar.progress`。

* 位置：`BattlePageManager.ts` 内新增私有方法。

### 3. 在伤害事件后触发团队进度刷新

* 在 `attachHeroControllers()` 的伤害回调中：

  * 现有代码处（BattlePageManager.ts:477-482、504-508）调用 `applyDamage` 后，接收返回的单体剩余百分比（用于日志或调试），随后调用 `updateTeamHpBars()` 即时刷新顶部条。

* 在开始战斗时（`onClickStart` → `attachHeroControllers` 之后）调用一次 `updateTeamHpBars()` 初始化显示。

## 细节与边界处理

* 节点销毁：死亡后节点会被移除（组件/HeroController.ts:508-512），`calcTeamHpPercentFromNodes` 会过滤 `!node.isValid`，不计入平均。

* 零生命上限：若 `maxHp<=0`，该成员按 0 计；避免除零。

* 百分比范围：所有百分比结果使用 `Math.max(0, Math.min(1, value))` 归一。

* 原有 `setLeftHp/setRightHp`（BattlePageManager.ts:405-416）保留，用于其他场景；团队条更新直接设置 `ProgressBar.progress`。

## 验证步骤

1. 启动战斗后，检查初始 `leftHpBar.progress`、`rightHpBar.progress` 是否为两侧队伍 `(∑个体百分比)/成员数`。
2. 触发普攻与技能（组件/HeroController.ts:267-276、256-265），观察每次受伤后顶部条即时变化，且回传的单体百分比与其头像数值一致。
3. 击杀后个体百分比为 0，顶部条平均值随成员减少（或为 0），无异常。

## 代码改动范围与影响

* 小范围改动：

  * 修改 `DamageManager.applyDamage` 的返回类型与末尾逻辑。

  * 在 `BattlePageManager` 新增两个私有方法，并在伤害回调与战斗开始处调用。

* 不影响现有动画、技能条、暂停/倍速逻辑（组件/HeroController.ts、BattlePageManager.ts 其他功能保持不变）。

## 后续可选增强

* 在 UI 上显示数值标签（例如“团队剩余 73%”）。

* 容错：当队伍为空时将进度隐藏或显示灰色。

